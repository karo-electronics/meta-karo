From 141cc99e45e545b58becaf4a9aa080de7c74ebe1 Mon Sep 17 00:00:00 2001
From: Chris Brandt <chris.brandt@renesas.com>
Date: Tue, 21 Jun 2022 11:24:24 -0400
Subject: [PATCH 4/4] drm: rcar-du: Modify clk div to support 2 lane MIPI DSI
 for RZ-G2L

Also add a 62.50MHz clock option
---
 drivers/gpu/drm/rcar-du/rcar_du_crtc.c | 107 ++++++++++++++-----------
 1 file changed, 60 insertions(+), 47 deletions(-)

diff --git a/drivers/gpu/drm/rcar-du/rcar_du_crtc.c b/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
index 617c001b136c..475c3ee339e9 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
@@ -224,7 +224,7 @@ struct cpg_param {
 	u32	dsi_div_b;
 };
 
-#define	TABLE_MAX		14
+#define	TABLE_MAX		15
 #define	TABLE_PARALLEL_MAX	11
 #define reg_write(x, a)		iowrite32(a, x)
 #define	reg_read(x)		ioread32(x)
@@ -250,92 +250,105 @@ struct cpg_param resolution_param[TABLE_MAX] = {
 	{
 		/* VGA 25.175MHz	*/
 		/* frequency		*/	25175,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	125,
-		/* pl5_fracin		*/	14680064,
-		/* pl5_postdiv1		*/	5,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	25,
+		/* pl5_fracin		*/	2936012,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* VGA 25.200MHz	*/
 		/* frequency		*/	25200,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	75,
-		/* pl5_fracin		*/	10066329,
-		/* pl5_postdiv1		*/	3,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	25,
+		/* pl5_fracin		*/	3355443,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* 480p/576p 27.000MHz	*/
 		/* frequency		*/	27000,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	81,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	27,
 		/* pl5_fracin		*/	0,
 		/* pl5_postdiv1		*/	3,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* 480p 27.027MHz	*/
 		/* frequency		*/	27027,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	81,
-		/* pl5_fracin		*/	1358954,
-		/* pl5_postdiv1		*/	3,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	27,
+		/* pl5_fracin		*/	452984,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* WVGA 29.605MHz	*/
 		/* frequency		*/	29605,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	88,
-		/* pl5_fracin		*/	13673431,
-		/* pl5_postdiv1		*/	3,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	29,
+		/* pl5_fracin		*/	10150216,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* SVGA 40.00MHz	*/
 		/* frequency		*/	40000,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	80,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	40,
 		/* pl5_fracin		*/	0,
-		/* pl5_postdiv1		*/	2,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
+	{
+		/* WXGA 62.50MHz	*/
+		/* frequency		*/	62500,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	62,
+		/* pl5_fracin		*/	8388608,
+		/* pl5_postdiv1		*/	1,
+		/* pl5_postdiv2		*/	1,
+		/* pl5_divval		*/	0,
+		/* pl5_spread		*/	0x16,
+		/* dsi_div_a		*/	3,      // 1/8
+		/* dsi_div_b		*/	2,      // 1/3
+	},
 	{
 		/* XGA	65.00MHz	*/
 		/* frequency		*/	65000,
-		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	130,
+		/* pl5_refdiv		*/	1,
+		/* pl5_intin		*/	65,
 		/* pl5_fracin		*/	0,
-		/* pl5_postdiv1		*/	2,
+		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
@@ -348,79 +361,79 @@ struct cpg_param resolution_param[TABLE_MAX] = {
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* 720p 74.176MHz	*/
 		/* frequency		*/	74176,
-		/* pl5_refdiv		*/	2,
+		/* pl5_refdiv		*/	1,
 		/* pl5_intin		*/	74,
 		/* pl5_fracin		*/	2952790,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* 720p 74.25MHz	*/
 		/* frequency		*/	74250,
-		/* pl5_refdiv		*/	2,
+		/* pl5_refdiv		*/	1,
 		/* pl5_intin		*/	74,
 		/* pl5_fracin		*/	4194304,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* FWXGA 1360x768 85.5MHz	*/
 		/* frequency		*/	85500,
-		/* pl5_refdiv		*/	2,
+		/* pl5_refdiv		*/	1,
 		/* pl5_intin		*/	85,
 		/* pl5_fracin		*/	8388608,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* WXGA+ 1440x900 88.75MHz		*/
 		/* frequency		*/	88750,
-		/* pl5_refdiv		*/	2,
+		/* pl5_refdiv		*/	1,
 		/* pl5_intin		*/	88,
 		/* pl5_fracin		*/	12582912,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
-		/* SXGA 108.0MHz		*/
+		/* SXGA 108.0MHz	*/
 		/* frequency		*/	108000,
-		/* pl5_refdiv		*/	2,
+		/* pl5_refdiv		*/	1,
 		/* pl5_intin		*/	108,
 		/* pl5_fracin		*/	0,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
 		/* pl5_divval		*/	0,
 		/* pl5_spread		*/	0x16,
-		/* dsi_div_a		*/	1,	// 1/2
+		/* dsi_div_a		*/	3,	// 1/8
 		/* dsi_div_b		*/	2,	// 1/3
 	},
 	{
 		/* 1080p 148.5MHz	*/
 		/* frequency		*/	148500,
 		/* pl5_refdiv		*/	2,
-		/* pl5_intin		*/	148,
+		/* pl5_intin		*/	140,
 		/* pl5_fracin		*/	8388608,
 		/* pl5_postdiv1		*/	1,
 		/* pl5_postdiv2		*/	1,
@@ -674,8 +687,8 @@ static void rcar_du_crtc_set_display_timing(struct rcar_du_crtc *rcrtc)
 			do {
 				val = reg_read(cpg_base + CPG_CPG_CLKSTATUS);
 			} while ((val & DIVDSILPCLK_STS) != 0);
-			/* SEL_PLL5_3 clock */
-			reg_write(cpg_base + CPG_OTHERFUNC1_REG, 0x10001);
+			/* SEL_PLL5_1 clock */
+			reg_write(cpg_base + CPG_OTHERFUNC1_REG, 0x10000);
 			/* DIV_DSI_A, DIV_DSI_B */
 			reg_write(cpg_base + CPG_PL5_SDIV, 0x01010000 |
 				 (paramPtr[index].dsi_div_a << 0) |
-- 
2.28.0

